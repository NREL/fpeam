from Module import Module
from FPEAM import (Data, utils)

LOGGER = utils.logger(name=__name__)


class FugitiveDust(Module):
    """Base class to manage execution of on-farm fugitive dust calculations"""

    def __init__(self, config, production, fugitive_dust_emission_factors,
                 crop_measure_type,
                 **kvals):
        """
        :param config [ConfigObj] configuration options
        :param production: [DataFrame] production values
        :param fugitive_dust_emission_factors: [DataFrame] fugitive dust
        generation per acre
        """

        # init parent
        super(FugitiveDust, self).__init__(config = config)

        # init properties
        self.production = production
        self.crop_measure_type = crop_measure_type

        # pre-process fugitive dust input file to calculate
        # fugitive dust generation per acre for one average year

        # sum the harvest and non-harvest fugitive dust emission factors
        # (sum over source_category)
        _fugitive_dust_sum = fugitive_dust_emission_factors.groupby([
            'feedstock', 'tillage_type', 'rotation_year', 'pollutant']).sum()

        # average fugitive dust emission factors over rotation_year within
        # each feedstock-tillage-pollutant combo
        # these average numbers get multiplied by acreages to calculate
        # fugitive dust by feedstock, tillage and region
        self.fugitive_dust = _fugitive_dust_sum.groupby(['feedstock',
                                                         'tillage_type',
                                                         'pollutant']).mean()

        # convert the indexes generated by .groupby back into columns to
        # enable a merge with production
        self.fugitive_dust.reset_index(level = ['feedstock', 'tillage_type',
                                                'pollutant'],
                                       inplace = True)

    def get_fugitivedust(self):
        """
        Calculate total PM10 and PM2.5 emissions from fugitive dust by
        feedstock, region and tillage type.

        :return: _df: DataFrame containing PM10 and PM2.5 amounts by
        feedstock, tillage type and region
        """

        # define columns used to merge production with fugitive_dust
        _idx = ['feedstock', 'tillage_type']

        # define list of columns of interest in production
        _prod_columns = ['row_id'] + _idx + ['region', 'crop_amount']

        # select only production rows corresponding to the user-defined crop
        #  measure
        _prod_rows = self.production.crop_measure == self.crop_measure_type

        # merge production with fugitive dust
        _df = self.production[_prod_rows][_prod_columns].merge(
            self.fugitive_dust, on = _idx)

        # calculate fugitive dust
        _df.eval('pollutant_amount = crop_amount * rate',
                 inplace = True)

        # clean up DataFrame
        # @TODO verify that these are the columns to return
        _df = _df[['row_id', 'feedstock', 'tillage_type', 'region',
                   'pollutant', 'pollutant_amount']].set_index('row_id',
                                                  drop = True)

        return _df